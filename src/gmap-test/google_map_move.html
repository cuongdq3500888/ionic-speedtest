<html>
<head>
<title>BAN DO HO TRO GIAO THONG</title>
<link rel="stylesheet" type="text/css" href="gmap.css" />
<style>
.highlight { background:yellow; }
.yui-skin-sam .yui-ac-input {VERTICAL-ALIGN: top; WIDTH: 13em; POSITION: static}
.yui-skin-sam .yui-ac-container {LEFT: 0px;WIDTH: 40em; font-size:9px}
.yui-skin-sam .yui-ac-content {width: 250px !important}
#map_site {Z-INDEX: 0;position:absolute;top:0%;left:0%;width:99%;height:98%;background-color:blue;border:7px solid #336}
#bAutoComplete {Z-INDEX: 999}
#lAutoComplete {Z-INDEX: 9000}
.menubutton{top:10;left:65;position:absolute;z-index:999}
</style>

<script type="text/javascript" src="https://maps.google.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing&key=AIzaSyBO4Jb4II4Luda_FJVEIwRGWftXPlbWB2o"></script>
<SCRIPT type="text/javascript" src="tool_tip_1.0.js"></SCRIPT>
<SCRIPT type="text/javascript" src="gmap_v4_objects.js"></SCRIPT>
<SCRIPT type="text/javascript" src="gmap_v4_marker_cluster.js"></SCRIPT>
	
<script src="jquery.min.js"></script>
</head>
<script type="text/javascript">
var icon_count = 0;
var vcount_ok = 0;
var vcount_nok = 0;
var vcount_save = 0;
var shop_type_default=6; //diem ban le
var shop_function_default=1; //hinh thuc ban hang
var ischeck_default=[0,0,0,0]; //!isbill,!isphone,!is1414,!ismobifone
/* var pub_scrypted="<%=pEncryptedShop_pub%>"; //chuoi ma hoa cho cac phien ajax */
var map;
var drawingManager;
var infowindow = new google.maps.InfoWindow({content: "test"});
var map_default={
		isauto:false,
		isdraw:false,
		d:0.0005,
		r:0.001,
		isize:30,
		vCenterX:16.057,
		vCenterY:108.199,
		vSize:15,
		maptype:google.maps.MapTypeId.ROADMAP,//maptyps=[google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.TERRAIN];
		LATmove:0.05,
		LONmove:0.1,
		functionType:4, //tim kiem bang dia chi, site_id, ISDN hoac IMEI (kieu so) (1,2,3,4)
		idir:"../icons/",
		imgs:["close.gif","taxi.png","site_blue.png","3g.png","4g.png","shop.png","man.png","woman.png","dot.png","cross-hairs.png","alarm.png","router32.png","tablet32.png","iphone4.png","phone32.png"],
		getimg:function(i){return(this.idir+this.imgs[i])}, //co 10 hinh de lay cho site, imei va search
		ishops:["mobifone.png","CH1.png","CH2.png","DLCK.png","DLC.png","DLBD.png","DBL.png","DBL0.png","CTV.png","THE.png","STDT.png","TTGD11.png","VTEL.png","VNA.png","mobifone.png"],
		getshop:function(i){return(this.idir+this.ishops[i])}, //co 7 hinh de lay cho kieu shop
		img:function(){return(this.idir+this.imgs[1])},
		iclose:function(){return(this.idir+this.imgs[0])},
		colors:["#ff0000","#00ff00","#0000ff","#F33F00","#FF0000","#FF6699","#FF66FF","#FF9999","#FF99FF","#FFCC99","#FFCCFF","#FFFF99","#FFFFCC","#CCFF66","#CCFFCC"],
        getcolor:function(i){return(this.colors[i])} //co 15 mau de lay
}
var now = new Date();
var day = ("0" + (now.getDate()-1)).slice(-2);
var month = ("0" + (now.getMonth() + 1)).slice(-2);
var today_1 = (day) + "/" + (month)+ "/"+ now.getFullYear();
		//alert(today);
</script>
<body class="yui-skin-sam">
<div id="jQpopup"><div class="view-container-jQ"></div></div>
	<!-- POPUP Page for image-->
<div id="jQpopupI"><div class="view-container-jQ-i"></div></div>
<div id="jQpopupModal"><div class="view-container-jQ"></div></div>
	<!-- POPUP Page for edit,add-->
<div id="jQpopupE"><div class="view-container-jQ-e"></div></div>
	<!-- POPUP Page for Traff-->
<div id="jQpopupT"><div class="view-container-jQ-t"></div></div>
	<!-- POPUP Page for alarm-->
<div id="jQpopupA"><div class="view-container-jQ-a"></div></div>
	<!-- POPUP Page for imei 3g-->
<div id="jQpopup3"><div class="view-container-jQ-3"></div></div>
	<!-- POPUP Page for District list-->
<div id="jQpopupL"><div class="view-container-jQ-l"></div></div>
<!-- POPUP Page for District list-->
<div id="jQpopupN"><div class="view-container-jQ-n"></div></div>
	<!-- POPUP Page for Precinct list-->
<div id="jQpopupPL"><div class="view-container-jQ-pl"></div></div>
<!-- POPUP Page for Precinct list-->
<div id="jQpopupPN"><div class="view-container-jQ-pn"></div></div>
<!-- div cho ban do-->
<script type="text/javascript">
	VMS_pmenu.initSearchWindow();
/////////////////////////////////////
// cac ham lien quan den AJAX chon Menu trung tam, tinh, huyen
function updateProvinceList(data){
		data = eval(data);
		$("#province").empty();
		/* for (i=0;i<data.length;i++) {
			$("#province").append("<option value='"+data[i][0]+"' "+(data[i][0]=="<%=province%>"?"selected":"")+">"+data[i][1]+"</option>");
		} */
		VMS_map.isBusy=false;
}
function refreshCenter() {
	if (VMS_map.isBusy){
		alert("Các tiến trình bản đồ đang bận. Xin vui lòng đợi trong giây lát hoặc refresh lại trang này.");
	}else{
		VMS_map.isBusy=true;
		$.ajax({
            url: "google_map_shop_detail_refresh_province.jsp",
            type: "POST",
            cache: false,
            data: "center="+$("#center").val(),
            success: function(obj){
				updateProvinceList(obj);
            },
            error: function (){
                alert("Có lỗi xảy ra khi gọi google_map_shop_detail_refresh_province.jsp!");
            }
        });
   	}
}
function updateDistrictList(data){
		data = eval(data);
		$("#district").empty();
		/* for (i=0;i<data.length;i++) {
			$("#district").append("<option value='"+data[i][0]+"' "+(data[i][0]=="<%=district%>"?"selected":"")+">"+data[i][1]+"</option>");
		} */
		VMS_map.isBusy=false;
 }
function refreshProvinces() {
	if (VMS_map.isBusy){
		alert("Các tiến trình bản đồ đang bận. Xin vui lòng đợi trong giây lát hoặc refresh lại trang này.");
	}else{
		//Cap nhap danh muc quan/huyen
		VMS_map.isBusy=true;
		$.ajax({
            url: "google_map_shop_detail_refresh_district.jsp",
            type: "POST",
            cache: false,
            data: "province="+$("#province").val()+"&center="+$("#center").val(),
            success: function(obj){
				updateDistrictList(obj);
            },
            error: function (){
                alert("Có lỗi xảy ra khi gọi google_map_shop_detail_refresh_district.jsp!");
            }
		});

       //focus chuyen ban do den tinh thanh
      if (!VMS_timer.busy){
      	VMS_map.isBusy=true;
        $.ajax({
            url: "google_map_shop_detail_get_province.jsp",
            type: "POST",
            cache: false,
            data: "center="+$("#center").val()+"&province="+$("#province").val(),
            success: function(obj){
				focusProvinceOnMap(obj);
            },
            error: function (){
                alert("Có lỗi xảy ra khi gọi google_map_shop_detail_get_province.jsp!");
            }
        });
  	}else{
  			alert("Bộ định thời đang xử lý. Xin vui lòng chờ đợi hiển thị điểm trên bản đồ xong");
  	}
  }
}
function focusProvinceOnMap(data){
	//thuc hien chuyen ban do ve vi tri duoc chon
	if (VMS_pmenu.isClean)VMS_map.clean();
	//lay cac thong tin option ve zoom de ve bang do
	var obj=eval(data).shift();
	if (obj.length>5){
		if (VMS_pmenu.isClean) VMS_map.map.setCenter(new google.maps.LatLng(obj[0],obj[1]),10);// map.setCenter(new google.maps.LatLng(obj[0],obj[1]),10);
		else VMS_map.map.setCenter(new google.maps.LatLng(obj[0],obj[1]));
		VMS_map.mapArea(obj[2],obj[0],obj[1],map_default.r+0.02/*+0.15*/,30,1,4,obj[3]); //ID,lat,lon,rộng của vùng,độ mịn, độ lớn của đường, số thứ tự màu,type
																				 	 //ID,la,lo,img,tooltip,type=-1=dragable
		VMS_map.mapLatLng(obj[2],obj[0],obj[1],map_default.getimg(5),obj[5],obj[3]); //ID,la,lo,img,tooltip,type=tinh,huyen,shop_type
	}
	VMS_map.isBusy=false;
}
function focusDistrictOnMap(data){
		//thuc hien chuyen ban do ve vi tri duoc chon
		// ve vu hien thi cua quan huyen
		if (VMS_pmenu.isClean)VMS_map.clean();
		//lay cac thong tin option ve zoom de ve bang do
		var obj=eval(data).shift();
		if (obj.length>5){
			if (VMS_pmenu.isClean) VMS_map.map.setCenter(new google.maps.LatLng(obj[0],obj[1]),15);
			else VMS_map.map.setCenter(new google.maps.LatLng(obj[0],obj[1]));
			VMS_map.mapArea(obj[2],obj[0],obj[1],map_default.r+0.01/*+0.025*/,60,1,3,obj[3]); //ID,lat,lon,rộng của vùng,độ mịn, độ lớn của đường, số thứ tự màu
			VMS_map.mapLatLng(obj[2],obj[0],obj[1],map_default.getimg(6),obj[5],obj[3]);
		}
		VMS_map.isBusy=false;
    };
function refreshDistricts() {
	if (VMS_map.isBusy){
		alert("Các tiến trình bản đồ đang bận. Xin vui lòng đợi trong giây lát hoặc refresh lại trang này.");
	}else{
		VMS_map.isBusy=true;
		//focus ban do den huyen
		$.ajax({
            url: "google_map_shop_detail_get_district.jsp",
            type: "POST",
            cache: false,
            data: "center="+$("#center").val()+"&province="+$("#province").val()+"&district="+$("#district").val(),
            success: function(obj){
				focusDistrictOnMap(obj);
            },
            error: function (){
                alert("Có lỗi xảy ra khi gọi google_map_shop_detail_get_location.jsp!");
            }
        });
	}
}
function showShopbyDistrictOnMap(data,distid){
		VMS_timer.push(eval(data));
		VMS_timer.fcall=function(obj){
			if (obj){
				VMS_map.mapLatLng(distid+"$"+obj[2],obj[0],obj[1],map_default.getshop(obj[3]),obj[5],obj[3]);
				if (VMS_map.latlngs[distid]) VMS_map.createLink(distid+"$"+obj[2],new google.maps.LatLng(obj[0],obj[1]),VMS_map.latlngs[distid].getPosition(),"#00FFFF",1);
			}else{
				//if (eval(data).length>10) 
				alert("Đã vẽ xong "+eval(data).length+" điểm\nTại: "+distid);
			}
			//kiem tra xong timeout?
		};
		VMS_timer.delay=1; //tra ve gia tri ban dau		
		VMS_timer.start();
		VMS_map.isBusy=false;
}
function showShopbyPrecinctOnMap(data,precinct){
		VMS_timer.push(eval(data));
		VMS_timer.fcall=function(obj){
			if (obj){
				VMS_map.mapLatLng(precinct+"$"+obj[2],obj[0],obj[1],map_default.getshop(obj[3]),obj[5],obj[3]);
				if (VMS_map.latlngs[precinct]) VMS_map.createLink(precinct+"$"+obj[2],new google.maps.LatLng(obj[0],obj[1]),VMS_map.latlngs[precinct].getPosition(),"#00FFFF",1);
			}else{
				//if (eval(data).length>10) 
				alert("Đã vẽ xong "+eval(data).length+" điểm\nTại: "+precinct);
			}
			//kiem tra xong timeout?
		};
		VMS_timer.delay=1; //tra ve gia tri ban dau		
		VMS_timer.start();
		VMS_map.isBusy=false;
}
//////////////////////////////////////	
var tOption="<table cellpadding='1' cellspacing='0' width='100%' border='1' style='border-collapse: collapse' bordercolor='#7AA7A7'>";
	tOption+="<tr><td width='30%'><select name='center' id='center' style='width:70px' onChange='refreshCenter();'><option value='all'>--Chọn TT--</option><option value='1'>TT1</option><option value='2'>TT2</option><option value='3'>TT3</option><option value='4'>TT4</option><option value='5'>TT5</option><option value='6'>TT6</option></select></td>";
	tOption+="<td width='30%'><select name='province' id='province' style='width:70px' onChange='refreshProvinces();'><option value='all'>--Chọn tỉnh--</option><option value='DNA'>Thành Phố Đà Nẵng</option></select></td>";
	tOption+="<td width='40%'><select style='width:150px' name='district' id='district' onchange='refreshDistricts();'><option value='all'>--Chọn huyện--</option></select> </td>";
	tOption+="</tr><table>";
	VMS_pmenu.addRow(tOption);
	//Thiet lap nut check lam sach ban do
	$("input:checkbox[name=Clean][value=Clean]").attr("checked", "checked");
	VMS_pmenu.isClean=true;
	///////////////////////
</script>
<div id="map">Đang lấy bản đồ từ Internet</div>
<div class="menubutton" name="menubutton" id="menubutton" style="width:10px;height:10px">
<a href="javascript:menubutton(1)" onmousemove="javascript:doTip(1)" onmouseout="javascript:hideTip()"><img border="0" src="../icons/1.png"></a>
<a href="javascript:menubutton(2)" onmousemove="javascript:doTip(2)" onmouseout="javascript:hideTip()"><img border="0" src="../icons/2.png"></a>
<a href="javascript:menubutton(3)" onmousemove="javascript:doTip(3)" onmouseout="javascript:hideTip()"><img border="0" src="../icons/3.png"></a>
<a href="javascript:menubutton(4)" onmousemove="javascript:doTip(4)" onmouseout="javascript:hideTip()"><img border="0" src="../icons/4.png"></a>
<a href="javascript:menubutton(5)" onmousemove="javascript:doTip(5)" onmouseout="javascript:hideTip()"><img border="0" src="../icons/5.png"></a>
</div>
</body>
</html>
<script type="text/javascript">
var markerCluster;
function showSiteVMS(data,cen){
	VMS_timer.push(eval(data));
	VMS_timer.delay=1; //tra ve gia tri ban dau
	VMS_timer.fcall=function(o){
		if (o){
			VMS_map.mapSite(o[2],o[0],o[1],map_default.getimg(o[3]));
		}else{
			//finish
			//alert ('xong day');
			//gan vao marker cluster de hien thi
			markerCluster = new MarkerClusterer(VMS_map.map, VMS_map.sites);
			//alert ('So luong ne = ' + VMS_map.sites.length);
		}
	};
	VMS_timer.start();
}
function view100Site(){
	var la=VMS_map.map.getCenter().lat();
	var lo=VMS_map.map.getCenter().lng();
	var lev=VMS_map.map.getZoom();
	//alert('test');
	$.ajax({
        url: "gmap_sql/qlm_gmap_sql_get_100site.jsp?la="+la
        	//"google_map_imei_3g_device_get_site.jsp?la="+la
        	+"&lo="+lo
        	+"&lev="+lev
        	+"&LATmove="+map_default.LATmove
        	+"&LONmove="+map_default.LONmove,
        type: 'POST',
        cache: false,
        success: function(o){
			showSiteVMS(o,VMS_map.map.getCenter());
        },
        error: function (){
            alert('Có lỗi xảy ra khi gọi gmap_sql/qlm_gmap_sql_get_100site!');
        }
    });
}
function showAlarm(data,center){
	if(data)if(data.length>10)VMS_map.clean();
	VMS_timer.push(eval(data));
	VMS_timer.delay=1; //tra ve gia tri ban dau
	VMS_timer.fcall=function(o){
		if (o){
			if (o[3]>0){
				VMS_map.mapSite(o[2],o[0],o[1],map_default.getimg(o[4]));
				VMS_map.mapAlarm(o[2],o[0],o[1],map_default.r+0.003,10,2,o[3]); ////sid,lat,lon,r,j,width,color
			}
			else{
				VMS_map.mapSite(o[2],o[0],o[1],map_default.getimg(o[4]));
				VMS_map.mapAlarmRemove(o[2]);
			}
		}
	};
	VMS_timer.start();
}
function viewAlarmOnline(){
	
	map_default.isauto = !map_default.isauto;
	if (map_default.isauto){
		VMS_timer.scheduleDelay=120000; //2 phut refresh trang 1 lan
		VMS_timer.stop=false;
		VMS_timer.fschedule=function(){
							//ham nay se chay dinh ky khi schedule duoc bat tu dong de chay
							var la=VMS_map.map.getCenter().lat();
							var lo=VMS_map.map.getCenter().lng();
							var lev=VMS_map.map.getZoom();
							$.ajax({
						        url: "map_ajax_get_alarms_online.jsp?la="+la
						        	+"&lo="+lo
						        	+"&LATmove="+map_default.LATmove
						        	+"&LONmove="+map_default.LONmove,
						        type: 'POST',
						        cache: false,
						        success: function(o){
									showAlarm(o,VMS_map.map.getCenter());
						        },
						        error: function (){
						            alert('Có lỗi xảy ra khi gọi map_ajax_get_alarms.jsp!');
						        }
						    });
						};
		VMS_timer.scheduleStart();
	}else{
		VMS_timer.stop=true;
		VMS_timer.fschedule = null;
	}
}

//////////////////////////////////////////////////////////////////
/// draw mode by cuong.dq 2017
var all_overlays = [];
var selectedShape;
var shapOptions = {
                    strokeWeight: 3,
                    strokeColor:map_default.getcolor(1),
                    fillOpacity: 0.45,
                    fillColor: map_default.getcolor(9),
            		clickable: true,
                    editable: true,
                    draggable: true
                    //,zIndex: 1
                  };
function clearSelection() {
    if (selectedShape) {
    	selectedShape.setDraggable(false);
	    if (selectedShape.type!=google.maps.drawing.OverlayType.MARKER){
	    	selectedShape.setEditable(false);
		}
      	selectedShape = null;
    }
  }

function showDrawingInfo(latlng,html,cmd){
	infowindow.close();
    infowindow.setContent("<div id='popup' style='text-align:center;width:450px;'>"
        				  +"<table border='0' width='100%'><tr><td>"
        				  +html+"</td></tr>"
        				  +"<tr><td align='center'>"
        				  +((cmd)?cmd:"&nbsp;")
        				  +"</td></tr></table></div>");
    infowindow.setPosition(latlng);
    infowindow.open(VMS_map.map);
}
function setSelection(s) {
    clearSelection();
    selectedShape = s;
    selectedShape.setDraggable(true);
	if (selectedShape.type!=google.maps.drawing.OverlayType.MARKER){
	    	selectedShape.setEditable(true);
	}
	
    switch (selectedShape.type) {
		case google.maps.drawing.OverlayType.MARKER: 
				showDrawingInfo(selectedShape.getPosition()
									,'MARKER.getPosition()='+selectedShape.getPosition()+'<br>'+
					  				 'MARKER.getDraggable()='+selectedShape.getDraggable()
									);
				break;
		case google.maps.drawing.OverlayType.CIRCLE:
				showDrawingInfo(selectedShape.getCenter()
									,'CIRCLE.getCenter()='+selectedShape.getCenter()+'<br>'+
					  				 'CIRCLE.getRadius()='+selectedShape.getRadius()
									);
				break;
		case google.maps.drawing.OverlayType.RECTANGLE:
				showDrawingInfo(selectedShape.getBounds().getCenter()
									,'RECTANGLE.getBounds().getNorthEast()='+selectedShape.getBounds().getNorthEast()+'<br>'+
					  				'RECTANGLE.getBounds().getSouthWest()='+selectedShape.getBounds().getSouthWest()
									);
				break;
		case google.maps.drawing.OverlayType.POLYGON: 
				
				showDrawingInfo(selectedShape.getPath().getArray()[0]
								,'POLYGON.getPath().getArray()='+selectedShape.getPath().getArray()+'<br>'+
								  'P=' + selectedShape.inKm()+' (km)' + '<br>' +
								  'S=' + (google.maps.geometry.spherical.computeArea(selectedShape.getPath())/1000000).toFixed(2) +' (km2)'
								,'<button onclick="getPolyInfo(1,\''+selectedShape.getPath().getArray()+'\')">SEND REQUEST</button>'
								);
				break;
		case google.maps.drawing.OverlayType.POLYLINE: 
				
				showDrawingInfo(selectedShape.getPath().getArray()[0]
								,'POLYLINE.getPath().getArray()='+selectedShape.getPath().getArray()+'<br>'+
								  'Length=' + selectedShape.inKm()+' (km)'
								,'<button onclick="getLineMoving(2,\''+selectedShape.getPath().getArray()+'\')">GET MOVE DEMO</button>'
								);
				//doTooltip(VMS_map.dist(selectedShape.getPath().getArray()[0],selectedShape.getPath().getArray()[1]);
				break;
		default: 
				break;
	}
    //selectColor(shape.get('fillColor') || shape.get('strokeColor'));
  }
  
var taxi;
var prevPosn;
var position;
var v=50; //km/h
var numDeltas=1; //cho 1 diem

function demoMove(p,a) {
	//latlng = a[0];
	//alert(latlng);
	prevPosn = a[0];
	taxi = new google.maps.Marker({ icon: map_default.getimg(1),
							        position: prevPosn,
							        map: VMS_map.map,
							        title: "Latitude: DAY LA TAXI NHE"
    });
    									   
    //moi lan get la co mot tap vi tri moi:
    //kc giua 2 vi tri 
    //van toc la 50km/h
    //kc = 1km
    //thoi gian di chuyen t=kc/v = 1km/50km/h=1h*60*60/50=72s=72diem
    //		
	VMS_timer.push(a); //a la mot array chua latlng ... 
	VMS_timer.delay=1000; //tra ve gia tri ban dau mot giay di chuyen qua 1 diem, 
	VMS_timer.fcall=function(o){
		if (o){
			//move taxi sang vi tri moi
			taxi.setTitle("("+o.lat()+","+o.lng()+")");
			//alert('kc m='+prevPosn.kmTo(o));
			//km/50km/h
		
			taxi.setIcon({
    				path: //'M -2,-2 2,2 M 2,-2 -2,2',
    					  //'M 150.53,202.04 C 154.81,196.70 159.93,195.42 161.98,191.82 163.21,189.66 163.00,186.44 163.00,184.00 163.00,184.00 163.00,108.00 163.00,108.00 163.08,101.35 165.23,86.29 167.22,80.00 168.75,75.16 172.18,69.04 175.24,65.00 198.30,34.56 238.99,37.61 273.00,38.00 290.33,38.21 311.28,42.41 325.00,53.45 339.40,65.04 347.91,81.41 348.00,100.00 348.00,100.00 348.00,112.00 348.00,112.00 348.00,112.00 349.00,128.00 349.00,128.00 349.00,128.00 349.00,184.00 349.00,184.00 349.00,186.44 348.79,189.66 350.02,191.82 352.05,195.38 357.49,196.98 361.61,202.04 366.06,207.50 366.00,212.40 366.00,219.00 358.67,218.33 355.56,215.83 349.00,213.00 349.00,213.00 349.00,249.00 349.00,249.00 349.02,258.63 350.21,256.10 350.93,262.00 350.93,262.00 350.93,275.00 350.93,275.00 350.88,283.70 349.02,280.96 349.00,292.00 349.00,292.00 349.00,349.00 349.00,349.00 349.00,349.00 349.99,364.00 349.99,364.00 349.99,364.00 349.00,378.00 349.00,378.00 349.00,378.00 349.00,422.00 349.00,422.00 348.98,434.83 346.63,449.17 336.00,457.61 324.23,466.95 302.67,470.60 288.00,472.16 262.16,474.93 228.27,475.04 203.00,468.87 191.83,466.14 178.40,462.30 171.04,452.96 163.93,443.94 163.02,432.10 163.00,421.00 163.00,421.00 163.00,378.00 163.00,378.00 163.00,378.00 162.01,361.00 162.01,361.00 162.01,361.00 163.00,347.00 163.00,347.00 163.00,347.00 163.00,289.00 163.00,289.00 162.89,282.48 162.00,283.54 161.13,279.00 161.13,279.00 161.13,265.00 161.13,265.00 161.13,257.09 162.98,259.16 163.00,249.00 163.00,249.00 163.00,213.00 163.00,213.00 156.44,215.83 153.33,218.33 146.00,219.00 146.01,212.07 145.91,207.81 150.53,202.04 Z M 192.00,56.75 C 183.73,62.69 175.89,70.71 173.53,81.00 172.73,84.45 172.99,93.04 173.00,97.00 173.01,100.75 172.96,102.32 174.00,106.00 182.49,99.31 192.58,76.90 199.78,67.00 205.30,59.42 210.57,59.35 213.00,50.00 205.01,47.80 198.33,52.19 192.00,56.75 Z M 339.00,87.00 C 338.77,68.65 317.84,49.40 300.00,49.00 300.36,59.43 305.99,58.44 312.22,67.00 312.22,67.00 320.80,81.00 320.80,81.00 320.80,81.00 337.00,107.00 337.00,107.00 340.16,102.12 339.07,92.84 339.00,87.00 Z M 252.00,136.00 C 242.46,136.01 226.28,137.68 217.00,139.88 208.40,141.92 199.22,144.84 191.00,148.06 186.24,149.93 182.41,151.16 183.06,157.00 183.06,157.00 188.58,183.00 188.58,183.00 188.58,183.00 198.67,224.00 198.67,224.00 198.67,224.00 205.05,243.00 205.05,243.00 205.05,243.00 211.25,260.00 211.25,260.00 212.53,264.55 213.37,271.23 213.83,276.00 214.10,278.83 213.68,282.41 215.02,284.91 216.07,286.86 218.34,288.69 220.00,290.15 221.85,291.77 223.65,293.54 226.00,294.40 227.95,295.12 230.90,295.00 233.00,295.00 233.00,295.00 279.00,295.00 279.00,295.00 281.09,295.00 284.06,295.12 286.00,294.40 289.42,293.14 295.20,287.25 296.83,284.00 296.83,284.00 300.15,263.00 300.15,263.00 300.15,263.00 313.66,224.00 313.66,224.00 313.66,224.00 330.00,152.00 330.00,152.00 301.12,139.58 283.37,135.95 252.00,136.00 Z M 173.00,247.00 C 173.00,247.00 173.00,274.00 173.00,274.00 173.01,276.34 172.94,279.66 173.87,281.82 175.61,285.85 185.91,291.17 190.00,293.00 190.00,293.00 190.00,271.00 190.00,271.00 190.00,271.00 187.28,241.00 187.28,241.00 187.28,241.00 183.83,221.04 183.83,221.04 183.83,221.04 173.00,212.00 173.00,212.00 170.19,219.07 172.96,238.69 173.00,247.00 Z M 328.29,220.32 C 326.56,223.27 325.26,236.86 324.72,241.00 324.72,241.00 322.00,272.00 322.00,272.00 322.00,272.00 321.00,293.00 321.00,293.00 325.21,291.77 336.72,285.82 338.40,281.82 339.12,280.10 339.00,276.91 339.00,275.00 339.00,275.00 340.00,212.00 340.00,212.00 336.66,213.63 330.16,217.13 328.29,220.32 Z M 174.00,323.00 C 174.00,323.00 175.00,362.00 175.00,362.00 175.01,368.07 174.69,371.40 182.00,371.90 183.31,371.99 185.50,371.98 186.69,371.40 189.96,369.80 188.88,362.46 189.28,359.00 189.28,359.00 190.00,337.00 190.00,337.00 190.00,337.00 191.00,319.00 191.00,319.00 190.95,310.22 189.94,312.05 175.00,305.00 173.27,309.35 174.00,318.05 174.00,323.00 Z M 322.02,313.39 C 321.12,314.80 321.09,316.39 321.02,318.00 321.02,318.00 322.00,335.00 322.00,335.00 322.00,335.00 322.72,359.00 322.72,359.00 323.07,362.00 322.36,369.21 324.60,370.98 327.26,373.08 334.88,372.00 336.40,368.72 337.43,366.52 336.96,353.36 337.00,350.00 337.00,350.00 338.00,337.00 338.00,337.00 338.00,337.00 338.00,305.00 338.00,305.00 334.33,306.28 323.99,310.30 322.02,313.39 Z M 178.00,390.00 C 178.00,390.00 181.00,409.00 181.00,409.00 183.96,401.30 184.98,396.24 185.00,388.00 185.00,388.00 178.00,390.00 178.00,390.00 Z M 333.40,392.11 C 332.63,388.24 328.06,387.23 327.03,390.30 325.75,394.09 329.67,405.74 332.00,409.00 332.00,409.00 333.40,392.11 333.40,392.11 Z M 191.31,429.00 C 190.14,431.60 188.05,436.11 189.20,438.91 190.34,441.67 194.45,443.88 197.00,445.22 203.18,448.46 213.25,452.75 220.00,454.35 230.38,456.80 235.01,456.41 245.00,457.09 245.00,457.09 257.00,458.00 257.00,458.00 269.60,458.02 283.88,456.62 296.00,453.14 301.85,451.46 316.67,445.46 320.82,441.47 326.29,436.21 317.94,422.83 315.30,417.00 314.30,414.77 312.81,410.27 310.61,409.13 307.47,407.50 299.21,412.72 296.00,414.14 285.78,418.65 274.17,420.98 263.00,421.00 249.87,421.02 238.88,421.41 226.00,417.70 226.00,417.70 200.00,408.00 200.00,408.00 200.00,408.00 191.31,429.00 191.31,429.00 Z M 177.10,447.79 C 181.59,451.99 185.66,452.18 191.00,454.09 198.51,456.77 200.48,458.28 209.00,460.00 203.75,453.99 195.37,451.50 189.00,446.48 180.14,439.52 177.92,434.44 173.00,425.00 168.62,431.77 171.47,442.51 177.10,447.79 Z M 325.00,444.82 C 317.40,451.53 308.55,453.46 303.00,460.00 310.05,458.91 313.63,456.90 320.00,454.46 323.99,452.93 328.33,452.31 332.00,450.01 340.91,444.41 342.31,434.48 340.00,425.00 335.12,430.52 335.29,435.73 325.00,444.82 Z',
    					  //'M 8.03,5.29 C 9.80,3.14 12.38,2.65 15.00,2.29 20.76,1.50 34.65,1.10 38.40,6.14 40.97,9.60 40.00,22.29 40.00,27.00 40.00,27.00 45.00,27.00 45.00,27.00 45.00,27.00 45.00,29.00 45.00,29.00 45.00,29.00 41.00,29.00 41.00,29.00 41.00,29.00 41.00,63.00 41.00,63.00 40.99,65.80 41.31,69.31 39.40,71.58 36.41,75.14 30.22,74.99 26.00,75.00 17.33,75.01 6.22,76.62 6.00,65.00 6.00,65.00 6.00,29.00 6.00,29.00 6.00,29.00 2.00,29.00 2.00,29.00 2.00,29.00 2.00,27.00 2.00,27.00 2.00,27.00 6.00,27.00 6.00,27.00 6.00,21.81 4.88,9.11 8.03,5.29 Z M 10.00,22.00 C 11.25,25.00 13.29,29.28 16.21,30.98 17.96,32.00 20.04,31.96 22.00,32.00 30.59,32.15 32.73,31.53 36.00,23.00 27.45,19.88 18.83,20.84 10.00,22.00 Z M 7.00,60.00 C 9.38,58.65 10.79,57.58 12.15,54.98 13.44,51.97 13.42,39.18 12.15,36.00 11.35,33.44 9.84,31.89 8.00,30.00 6.07,34.87 7.00,53.62 7.00,60.00 Z M 34.89,35.02 C 33.54,38.17 33.56,51.86 34.89,54.98 35.95,57.29 37.22,58.37 39.00,60.00 39.00,60.00 39.00,30.00 39.00,30.00 37.07,31.66 35.88,32.55 34.89,35.02 Z M 15.00,58.00 C 15.00,58.00 10.00,67.00 10.00,67.00 20.49,67.85 26.47,69.41 37.00,66.00 29.29,55.38 26.18,60.72 15.00,58.00 Z',
    					  //'M 5.60,4.30 C 9.29,-0.23 21.91,-0.11 24.98,5.14 26.45,7.66 26.00,14.86 26.00,18.00 26.00,18.00 29.00,19.00 29.00,19.00 27.80,19.80 27.30,19.74 26.59,21.29 25.60,23.48 26.01,35.78 26.00,39.00 25.99,41.53 26.34,45.36 24.40,47.26 21.59,50.02 7.35,49.95 5.02,46.57 3.87,44.89 4.01,41.97 4.00,40.00 4.00,40.00 4.00,19.00 4.00,19.00 4.00,19.00 1.00,18.00 1.00,18.00 6.79,14.12 1.83,8.91 5.60,4.30 Z M 7.00,14.00 C 7.45,15.79 7.64,17.18 8.89,18.69 11.36,21.67 17.60,21.70 20.53,19.40 22.03,18.22 22.97,16.56 24.00,15.00 16.84,12.02 14.31,13.04 7.00,14.00 Z M 5.00,40.00 C 10.71,34.81 10.23,25.99 6.00,20.00 6.00,20.00 5.00,40.00 5.00,40.00 Z M 25.00,39.00 C 25.00,39.00 25.00,20.00 25.00,20.00 19.29,24.87 19.29,34.13 25.00,39.00 Z M 6.00,44.00 C 13.64,45.37 16.36,45.37 24.00,44.00 19.57,35.80 10.43,35.80 6.00,44.00 Z',
    					  //'M 5.60,4.30 C 9.29,-0.23 21.91,-0.11 24.98,5.14 26.41,7.60 26.00,13.99 26.00,17.00 26.00,17.00 30.00,17.00 30.00,17.00 30.00,17.00 30.00,20.00 30.00,20.00 30.00,20.00 26.00,20.00 26.00,20.00 26.00,20.00 26.00,40.00 26.00,40.00 25.98,42.34 26.21,45.49 24.40,47.26 21.59,50.02 7.35,49.95 5.02,46.57 3.87,44.89 4.01,41.97 4.00,40.00 4.00,40.00 4.00,20.00 4.00,20.00 4.00,20.00 0.00,20.00 0.00,20.00 0.00,20.00 0.00,17.00 0.00,17.00 0.00,17.00 4.00,17.00 4.00,17.00 4.00,13.52 3.38,7.01 5.60,4.30 Z M 7.00,14.00 C 7.45,15.79 7.64,17.18 8.89,18.69 11.36,21.67 17.60,21.70 20.53,19.40 22.03,18.22 22.97,16.56 24.00,15.00 16.84,12.02 14.31,13.04 7.00,14.00 Z M 7.00,40.00 C 10.93,33.40 11.55,26.44 7.00,20.00 5.42,23.99 5.42,36.01 7.00,40.00 Z M 24.00,39.00 C 24.00,39.00 24.00,20.00 24.00,20.00 18.29,24.87 18.29,34.13 24.00,39.00 Z M 6.00,44.00 C 13.64,45.37 16.36,45.37 24.00,44.00 19.57,35.80 10.43,35.80 6.00,44.00 Z',
    					  'M 5.60,4.30 C 9.29,-0.23 21.91,-0.11 24.98,5.14 26.41,7.60 26.00,13.99 26.00,17.00 26.00,17.00 30.00,17.00 30.00,17.00 30.00,17.00 30.00,20.00 30.00,20.00 30.00,20.00 26.00,20.00 26.00,20.00 26.00,20.00 26.00,40.00 26.00,40.00 25.98,42.34 26.21,45.49 24.40,47.26 21.59,50.02 7.35,49.95 5.02,46.57 3.87,44.89 4.01,41.97 4.00,40.00 4.00,40.00 4.00,20.00 4.00,20.00 4.00,20.00 0.00,20.00 0.00,20.00 0.00,20.00 0.00,17.00 0.00,17.00 0.00,17.00 4.00,17.00 4.00,17.00 4.00,13.52 3.38,7.01 5.60,4.30 Z M 7.00,15.00 C 10.40,23.37 19.60,23.37 23.00,15.00 16.93,12.19 13.11,12.46 7.00,15.00 Z M 7.00,40.00 C 10.93,33.40 11.55,26.44 7.00,20.00 5.42,23.99 5.42,36.01 7.00,40.00 Z M 24.00,39.00 C 24.00,39.00 24.00,20.00 24.00,20.00 18.29,24.87 18.29,34.13 24.00,39.00 Z M 7.00,44.00 C 12.69,45.38 17.31,45.38 23.00,44.00 19.37,35.76 10.63,35.76 7.00,44.00 Z',
						  //google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
				    strokeColor: '#7B7B7B',
				    strokeWeight: 1,
				    fillColor: '#FFFF7C',
				    fillOpacity: 1,
				    scale: 1,
				    rotation: google.maps.geometry.spherical.computeHeading(prevPosn,o)// taxi.getPosition())
				  });
			//quay dau truoc roi moi thiet lap vi tri nay sau
			numDeltas=(prevPosn.kmTo(o)*60*60*100/v).toFixed(0);
			
			//alert("point="+numDeltas);
			
			if (numDeltas>0){
			 	VMS_timer.delay=numDeltas*10;
			 	position = [prevPosn.lat(),prevPosn.lng()]; //lay toa do truoc do
			 	transition([o.lat(), o.lng()]); //chuyen dong toc do 50km/h
			} else {
				VMS_timer.delay=1000;
				taxi.setPosition(o); //chuyen dong ngay
			}
			//cho di chuyen smoothly giua 2 diem nay
			//taxi.setPosition(o);
			prevPosn = o; //thiet lap vi tri tiep theo
    		//di chuyen den diem moi ne
    		
    		
		}
	};
	VMS_timer.start();
	
}

//start moving smoothly
var delaysmoothly = 10; //milliseconds
var ii = 0;
var deltaLat;
var deltaLng;

function transition(result){
    ii = 0;
    deltaLat = (result[0] - position[0])/numDeltas;
    deltaLng = (result[1] - position[1])/numDeltas;
    moveSmoothly();
}

function moveSmoothly(){
    position[0] += deltaLat;
    position[1] += deltaLng;
    
    var latlng = new google.maps.LatLng(position[0], position[1]);
    
    taxi.setTitle("("+position[0]+","+position[1]+")");
    
    taxi.setPosition(latlng);
    if(ii!=numDeltas){
        ii++;
        setTimeout(moveSmoothly, delaysmoothly);
    }
}
//////end moving smoothly
function getLineMoving(t,ar){
	demoMove(selectedShape.getPath(),selectedShape.getPath().getArray());
}

function deleteSelectedShape() {
    if (selectedShape) {
      selectedShape.setMap(null);
    }
  }
function deleteAllShape() {
  for (var i=0; i < all_overlays.length; i++)
  {
    all_overlays[i].overlay.setMap(null);
  }
  all_overlays = [];
}
function viewDrawOnline(){
	
	map_default.isdraw = !map_default.isdraw;
	if (map_default.isdraw && VMS_map.map!=null){
		//cuongdq test cong cu ve
		drawingManager = new google.maps.drawing.DrawingManager({
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: [	//'marker', 
            				//'circle', 
            				//'polygon', 
            				'polyline'//, 
            				//'rectangle'
            				]
          },
          markerOptions: {icon: map_default.getimg(9),
          				  draggable: true},
          polylineOptions:  shapOptions,
          rectangleOptions: shapOptions,
          circleOptions:    shapOptions,
          polygonOptions:   shapOptions,
        });
        // To show:
		drawingManager.setOptions({
		  drawingMode: google.maps.drawing.OverlayType.POLYLINE,
		  drawingControl: true	  
		});
		  
        drawingManager.setMap(VMS_map.map);
        
        //them su kien de lay doi tuong sau khi ve xong
        google.maps.event.addListener(drawingManager, "overlaycomplete", function(event) {
        		//them mot doi tuong da ve vao mang de theo doi
        		all_overlays.push(event);
        		//sau khi ve xong thi khong cho ve tiep
        		drawingManager.setDrawingMode(null);

				var newShape = event.overlay;
					newShape.type = event.type;
					
				google.maps.event.addListener(newShape, 'click', function() {
											          setSelection(newShape);
											        });
        		
        		setSelection(newShape);
        		
			});
		
		//cuongdq
	} else {
		//hide draw 
		drawingManager.setOptions({
		  drawingControl: false
		});
		drawingManager.setMap(null);
  		drawingManager = null;
  		//xoa doi tuong duoc chon
  		//deleteSelectedShape();
  		//xoa het cac doi tuong nhe
  		deleteAllShape();
	}
}
function showPolygonInfo(o){
	alert(''+o);
}
function getPolyInfo(t,sh){
		$.ajax({url: "gmap_sql/gmap_v4_get_poly.jsp?type="+t+"&arr="+sh,
				        type: 'POST',
				        cache: false,
				        success: function(o){
				        	showPolygonInfo(o);
				        },
				        error: function (){
				            alert('Có lỗi xảy ra khi gọi gmap_v4_set_gshapes!');
				        }
				    });
}

/// END draw mode by cuong.dq 2017
//////////////////////////////////////////////////////////////////
//ve anten cho cac cell
function showCellAntena(id){
	$.ajax({
		url: "gmap_sql/qlm_gmap_sql_cell_directions.jsp?id="+id,
		type: 'POST',
		cache: false,
		success: function(data){
			var o = eval(data);
			var lat = o[2][0];
			var lon = o[2][1];
			VMS_map.createCells(lat, lon, o[1],map_default.r+0.005,'#000080',2);
		},
		error: function (){
			alert('Có lỗi xảy ra khi gọi qlm_gmap_sql_cell_directions.jsp!');
		}
		});
}
function menubutton(func){
	switch (func) {
		case 1: //hien thi ban dieu khien
				VMS_pmenu.initSearchWindow();
				break;
		case 2: //ve 100 tram quanh khu vuc quan sat
				view100Site();
				break;
		case 3: //xem canh bao online
				viewAlarmOnline();
				break;
		case 4: //reset cac doi tuong tren bang do
				viewDrawOnline();
				break;
		case 5: //
				VMS_map.clean();
				break;
		case 6: //
				break;
		case 7: //
				break;
		case 8: //
				break;
		case 9: //
				break;
		default: //
				break;
				
	}
}
function doTip(func){
	switch (func) {
		case 1: //hien thi ban dieu khien
				doTooltip('Hiển thị bảng điều khiển tìm kiếm');
				break;
		case 2: //ve 100 tram quanh khu vuc quan sat
				doTooltip('Xem 100 trạm hoạt động tại khu vực quang sát');
				break;
		case 3: //xem canh bao online
				doTooltip((!map_default.isauto?' Xem cảnh báo tự động tại khu vực quang sát':'v Tắt cảnh báo tự động tại khu vực quang sát'));
				break;
		case 4: //reset cac doi tuong tren bang do
				doTooltip((!map_default.isdraw?' Mở công cụ vẽ':'v Tắt công cụ vẽ'));
				break;
		case 5: //
				doTooltip('Reset toàn bộ trên bản đồ');
				break;
		case 6: //
				break;
		case 7: //
				break;
		case 8: //
				break;
		case 9: //
				break;
		default: //
				break;
				
	}
}
function pointCommand(sid,func){	
	
	infowindow.close();
	
	switch (func) {
		case 1: //Hướng cell
				showCellAntena(sid);
				break;
		case 2: //Lưu lượng
				loadTraff(sid);
				break;
		case 3: //Cảnh báo
				doAjaxPopupForm("jQpopup",
						"view-container-jQ",
						"gmap_sql/gmap_v3_alarm_site.jsp?sid="+sid,
						"Các cảnh báo trạm trong 7 ngày gần đây",
						400,
						800,
						true,
						true); //div_id, div_class, url, title, h, w, modal, resizable
				break;
		case 4: //Tuyến
				
				break;
		case 5: //Kết nối
		
				break;
		case 6: //Chất lượng site theo ngày
				loadDate(sid,today_1);
				break;
		case 7: //
				break;
		case 8: //
				break;
		case 9: //
				break;
		default: //
				break;
				
	}
}
function loadTraff(s,sd,ed){
	var a1="";
	if (sd!=null) a1=a1+"&staDate="+sd;
	if (ed!=null) a1=a1+"&endDate="+ed;
		doAjaxPopupForm("jQpopup",
						"view-container-jQ",
						"gmap_sql/gmap_v3_traffic_site.jsp?sid="+s+a1,
						"Biểu đồ lưu lượng trạm trong các ngày",
						600,
						700,
						true,
						true); //div_id, div_class, url, title, h, w, modal, resizable
}
function reloadTraff(s,sd,ed){
	$("#jQpopup").dialog("close");
	loadTraff(s,sd,ed);
}
function loadDate(s,d){
	doAjaxPopupForm("jQpopup",
						"view-container-jQ",
						"gmap_sql/gmap_v3_traffic_site_hours.jsp?sid="+s+"&reportDate="+d,
						"Biểu đồ lưu lượng một ngày",
						700,
						800,
						true,
						true); //div_id, div_class, url, title, h, w, modal, resizable
}
function reloadDate(s,d){
	$("#jQpopup").dialog("close");
	loadDate(s,d);
}
</script>
<script type="text/javascript">

VMS_map.cellClick = function(id){
	alert('Click vao cell: '+id+'\n');
}
function showSiteTraffic(id){
		doAjaxPopupForm("jQpopup",
						"view-container-jQ",
						"gmap_sql/gmap_v3_traffic_site.jsp?sid="+id,
						"Biểu đồ lưu lượng trạm trong 7 ngày gần đây",
						300,
						600,
						true,
						true); //div_id, div_class, url, title, h, w, modal, resizable
}
function showSiteInfo(id,html,cmd){
	infowindow.close();
        infowindow.setContent("<div id='popup' style='text-align:center;width:450px;'>"
        											+"<table border='0' width='100%'><tr><td>"
        											+html+"</td></tr>"
        											+"<tr><td align='center'>"
        											+((cmd)?cmd:"&nbsp;")
        											+"</td></tr></table></div>");
	if(VMS_map.sites[id]){
		infowindow.open(VMS_map.map, VMS_map.sites[id]);
	}else if(VMS_map.latlngs[id]){
		infowindow.open(VMS_map.map, VMS_map.latlngs[id]);
	}
}
VMS_map.areaClick = function (id){
	//click trên vùng polygon của cảnh báo hoặc area
	if(VMS_map.alarms[id]){
		//nếu có thiết lập isalarm thì nó là cảnh báo
		$.ajax({
        url: "gmap_sql/gmap_v3_alarm_click.jsp?sid="+id,
        type: 'POST',
        cache: false,
        success: function(o){
			showSiteInfo(id,o,'');
        },
        error: function (){
            alert('Có lỗi xảy ra khi gọi gmap_v3_alarm_click.jsp!');
        }
    	});
	}
	//click các vùng tỉnh huyện xã
	if (VMS_map.areas[id]){
		switch (VMS_map.areas[id].areatype) {
		case -1: //Cấp Tỉnh
				var cmd="<table cellpadding='1' cellspacing='0' width='100%' border='1' style='border-collapse: collapse' bordercolor='#7AA7A7'>";
					cmd+="<tr><td width='100%' colspan='4' align='center'><b>QUẢN LÝ ĐIỂM BÁN MOBIFONE CẤP TỈNH</b></td></tr>";
					cmd+="<td width='25%' align='center'><input type='button' value='Xuất Excel' onclick='doCommandDistrict(\""+id+"\",5);' onmousemove='doTooltip(\"Xuất danh sách ĐGD của toàn bộ Tỉnh/TP này\");'  onmouseout='hideTip();'/></td>";
					cmd+="<td width='25%' align='center'><input type='button' value='Tìm Tọa Độ' onclick='doCommandDistrict(\""+id+"\",6);' onmousemove='doTooltip(\"Tìm Tọa độ tự động cho những ĐGD đã IMPORT nhưng chưa có tọa độ\");'  onmouseout='hideTip();'/></td>";
					cmd+="<td width='25%' align='center'><input type='button' value='Quận/Huyện' onclick='doCommandDistrict(\""+id+"\",7);' onmousemove='doTooltip(\"Xem phân bố các đơn vị hành chính cấp Quận/Huyện của Tỉnh/TP này\");'  onmouseout='hideTip();'/></td>";
					cmd+="</tr><table>";
				if(VMS_map.latlngs[id]) {
					infowindow.close();
        			infowindow.setContent("<div id='popup' style='text-align:center;width:350px;'>"
        											+"<table border='0' width='100%'><tr><td>"
        											+VMS_map.latlngs[id].latlngAddress+"</td></tr>"
        											+"<tr><td align='center'>"
        											+((cmd)?cmd:"&nbsp;")
        											+"</td></tr></table></div>");
					infowindow.open(VMS_map.map, VMS_map.latlngs[id]);
				}
				break;
		case -2: //Cấp Huyện
				var cmd="<table cellpadding='1' cellspacing='0' width='100%' border='1' style='border-collapse: collapse' bordercolor='#7AA7A7'>";
					cmd+="<tr><td width='100%' colspan='5' ALIGN='center'><b>QUẢN LÝ ĐIỂM BÁN MOBIFONE CẤP QUẬN HUYỆN</b></td></tr>";
					cmd+="<tr><td width='20%' align='center'><input type='button' value='DSách' onclick='doCommandDistrict(\""+id+"\",2);' onmousemove='doTooltip(\"Xem danh sách Điểm giao dịch Mobifone của Quận/Huyện này\");'  onmouseout='hideTip();'/></td>";
					cmd+="<td width='20%' align='center'><input type='button' value='Excel' onclick='doCommandDistrict(\""+id+"\",3);' onmousemove='doTooltip(\"Xuất danh sách ĐGD của toàn bộ Quận/Huyện này\");'  onmouseout='hideTip();'/></td>";
					cmd+="<td width='20%' align='center'><input type='button' value='Thêm Mới' onclick='doCommandDistrict(\""+id+"\",1);' onmousemove='doTooltip(\"Tạo một ĐGD mới của MobiFone cho Quận/Huyện này\");'  onmouseout='hideTip();'/></td>";
					cmd+="<td width='20%' align='center'><input type='button' value='ĐGDịch' onclick='doCommandDistrict(\""+id+"\",4);' onmousemove='doTooltip(\"Định vị các điểm giao dịch thuộc Quận/Huyện này\");'  onmouseout='hideTip();'/></td>";
					cmd+="<td width='20%' align='center'><input type='button' value='Ph/Xã' onclick='doCommandDistrict(\""+id+"\",8);' onmousemove='doTooltip(\"Xem Phân bố các đơn vị hành chính Phường/Xã của Quận/Huyện này\");'  onmouseout='hideTip();'/></td>";
					cmd+="</tr><table>";
				if(VMS_map.latlngs[id]) {
					infowindow.close();
        			infowindow.setContent("<div id='popup' style='text-align:center;width:350px;'>"
        											+"<table border='0' width='100%'><tr><td>"
        											+VMS_map.latlngs[id].latlngAddress+"</td></tr>"
        											+"<tr><td align='center'>"
        											+((cmd)?cmd:"&nbsp;")
        											+"</td></tr></table></div>");
					infowindow.open(VMS_map.map, VMS_map.latlngs[id]);
				}
				break;				
		case -3: //Cấp Phường Xã
				var cmd="<table cellpadding='1' cellspacing='0' width='100%' border='1' style='border-collapse: collapse' bordercolor='#7AA7A7'>";
					cmd+="<tr><td width='100%' colspan='3' ALIGN='center'><b>QUẢN LÝ ĐIỂM BÁN MOBIFONE CẤP PHƯỜNG XÃ</b></td></tr>";
					cmd+="<tr><td width='30%' align='center'><input type='button' value='Xem DSách' onclick='doCommandDistrict(\""+id+"\",9);' onmousemove='doTooltip(\"Xem danh sách Điểm giao dịch Mobifone của Phường/Xã này\");'  onmouseout='hideTip();'/></td>";
					cmd+="<td width='30%' align='center'><input type='button' value='Thêm Mới' onclick='doCommandDistrict(\""+id+"\",11);' onmousemove='doTooltip(\"Tạo một ĐGD mới của MobiFone cho Phường/Xã này\");'  onmouseout='hideTip();'/></td>";
					cmd+="<td width='40%' align='center'><input type='button' value='Xem Vị trí ĐGD' onclick='doCommandDistrict(\""+id+"\",10);' onmousemove='doTooltip(\"Định vị các điểm giao dịch thuộc Phường/Xã này\");'  onmouseout='hideTip();'/></td>";
					cmd+="</tr><table>";
				if(VMS_map.latlngs[id]) {
					infowindow.close();
        			infowindow.setContent("<div id='popup' style='text-align:center;width:350px;'>"
        											+"<table border='0' width='100%'><tr><td>"
        											+VMS_map.latlngs[id].latlngAddress+"</td></tr>"
        											+"<tr><td align='center'>"
        											+((cmd)?cmd:"&nbsp;")
        											+"</td></tr></table></div>");
					infowindow.open(VMS_map.map, VMS_map.latlngs[id]);
				}
				break;
		}//case 
	}
}
VMS_map.pointClick = function(id,ad){
	//Kiểm tra đối tượng có id là site hay là latlon
	var cmd = "";
	var url = "";
	if(VMS_map.sites[id]){
		cmd = "<table border='0' width='98%'><tr>";
		cmd += "<td style='cursor:hand;background-color:#5493B4;color: #ffff00;' onclick='pointCommand(\""+id+"\",1)'>Hướng cell</td>";
		cmd += "<td style='cursor:hand;background-color:#5493B4;color: #ffff00;' onclick='pointCommand(\""+id+"\",2)'>Lưu lượng</td>";
		cmd += "<td style='cursor:hand;background-color:#5493B4;color: #ffff00;' onclick='pointCommand(\""+id+"\",3)'>Cảnh báo</td>";
		cmd += "<td style='cursor:hand;background-color:#5493B4;color: #ffff00;' onclick='pointCommand(\""+id+"\",4)'>Tuyến</td>";
		cmd += "<td style='cursor:hand;background-color:#5493B4;color: #ffff00;' onclick='pointCommand(\""+id+"\",5)'>Kết nối</td>";
		cmd += "<td style='cursor:hand;background-color:#5493B4;color: #ffff00;' onclick='pointCommand(\""+id+"\",6)'>Chất lượng</td>";
		cmd += "</tr></table>";
		url = "gmap_sql/qlm_gmap_v3_site_click.jsp?sid="+id;
	}else if(VMS_map.latlngs[id]){
		var distid=id.substring(0,id.lastIndexOf("$"));
		var shopid=id.substring(id.lastIndexOf("$")+1);
		cmd = "<table border='0' width='98%'>\<!--<tr>";
		cmd += "<td style='cursor:hand;background-color:#5493B4;color: #ffff00;' onclick='pointCommand(\""+id+"\",11)'>Điều chỉnh thông tin</td>";
		cmd += "<td style='cursor:hand;background-color:#5493B4;color: #ffff00;' onclick='pointCommand(\""+id+"\",12)'>Xem hình ảnh</td>";
		cmd += "</tr>-->\</table>";
		url = "gmap_sql/gmap_v3_shop_click.jsp?sid="+shopid;
	}
		
	$.ajax({
        url: url,
        type: 'POST',
        cache: false,
        success: function(o){
			showSiteInfo(id,o,cmd);
        },
        error: function (){
            alert('Có lỗi xảy ra khi gọi pointClick!');
        }
    });
    
}
function doSavePointDrag(data,id){
	if (data){
		if (data.substring(0,3)=="200"){
			alert("Đã lưu tọa độ mới theo vị trí vừa chuyển đến thành công OK");
			//goi ham lay thong tin de hien thi len cua diem nay
			if((VMS_map.latlngs[id])&&(id.lastIndexOf("$")>1)){
				var distid=id.substring(0,id.lastIndexOf("$"));
				var shopid=id.substring(id.lastIndexOf("$")+1);
				//ajaxURLCallback("kpp_shop_google_map_shop_detail_get_shop_infor.jsp?shop_id="+shopid,viewShopDetailInfo,false,id);
				$.ajax({url: "gmap_sql/gmap_v3_shop_click.jsp?sid="+shopid,
				        type: 'POST',
				        cache: false,
				        success: function(o){
				        	showSiteInfo(id,o,'');
				        },
				        error: function (){
				            alert('Có lỗi xảy ra khi gọi pointClick!');
				        }
				    });

			}
		}else{
			alert(data+"\n"+id);
		}
	}
}

VMS_map.pointEdit = function(id,la,lo,ad,edit_type){
	//ham nay sau khi keo tha ra
	//alert('Địa chỉ sau khi kéo thả mới là:\n'+ad);
	var ok = false;
	var s=2;
	if(VMS_map.latlngs[id]) {
		if (edit_type) {
			ok = true;
			s = edit_type;
		} else if((!(edit_type)) && confirm("Bạn muốn điều chỉnh địa điểm "+id+" đến địa chỉ mới như sau không?\n\n"+ad+ "\n\n(Có=OK/Không=cancel)")){
			ok = true;
		} else {
			ok = false;	
		}
		
		if (ok) {
			var distid=id.substring(0,id.lastIndexOf("$"));
			var shopid=id.substring(id.lastIndexOf("$")+1);
			if (s==2&&VMS_map.links[id]&&VMS_map.latlngs[distid]) VMS_map.createLink(id,VMS_map.latlngs[id].getPosition(),VMS_map.latlngs[distid].getPosition(),"#FF0000",1);
			$.ajax({url: "google_map_shop_detail_save_point.jsp?d="+shopid+"&s="+s+"&la="+la+"&lo="+lo+"&g="+ad,
			        type: 'POST',
			        cache: false,
			        success: function(o){
			        	if (s==2) doSavePointDrag(o,id);
			        },
			        error: function (){
			            alert('Có lỗi xảy ra khi gọi pointClick!');
			        }
			    });
			//khi cap nhap duoc diem moi thi di chuyen duong link ve vi tri moi
		}
	}
	
}
VMS_map.pointDrag = function(id,la,lo){
	//ghi ket qua toa do ra trong luc keo
}
VMS_map.loadDataFirst = function(){
	//bien d duoc lay tu ajax tra ve dang [[lat,lon,\"sitid\",...],[<1tap cua site>]]
	//do ajax tra ve la mot chuoi data='[[],[]]'
	//ta phai chuyen doi dang chuoi sang dang mang
	//var d = eval(data);
	var d=[[map_default.vCenterX,map_default.vCenterY,'SITE1']
			,[map_default.vCenterX-0.05,map_default.vCenterY-0.01,'SITE2']
			,[map_default.vCenterX,map_default.vCenterY+0.05,'SITE3']
		];
	if(d) if(d.length>0){
		var j=d[0]; VMS_map.map.setCenter(new google.maps.LatLng(j[0],j[1]));
		VMS_timer.push(d);
		VMS_timer.fcall=function(o){
			if (o){
				//ve tram
				/*VMS_map.mapLatLng(o[2],
									o[0],o[1],
									map_default.getimg(1),
									'Đây là tooltip của tôi',
									-1); //ID,la,lo,img,tooltip,type=-1=dragable
				VMS_map.createLine(o[2]+'_L',
						new google.maps.LatLng(o[0],o[1]),
						new google.maps.LatLng(16.291982, 108.821856),
						'#ff0000',5);
				var cells=[[o[2]+'1',o[2]+'2',o[2]+'3'],[0,120,270]];
				VMS_map.createCells(o[0],o[1],cells,map_default.r+0.05,'#FF0000',2);
				*/
				
				//Vẽ thử một đối tượng trên bản đồ
				//var p2 = new google.maps.LatLng(16.291982, 108.821856);
				//var p3 = VMS_map.searchAddress('Phú lộc, Thừa Thiên Huế, Việt Nam');
				//Vẽ một đường thẳng lên bản đồ
				
				//ve duong tron //lat,lon, ban kinh,buoc nhay, mau, do rong
				//VMS_map.drawCircle(map_default.vCenterX,map_default.vCenterY,map_default.r+0.05,1,'#FFFF00',2);
				//VMS_map.drawCell(map_default.vCenterX,map_default.vCenterY,90,map_default.r+0.05,60,'#FFFF00',2);
				//ID, Lat,lon,goc,bankinh,mau,dorongduong
				//VMS_map.createCell('Cell1',map_default.vCenterX,map_default.vCenterY,90,map_default.r+0.05,'#FFFF00',2);
				//Tao mot tap cell //lat,lon,cells,r,color,dorongduong
				
				//alert('test');

				
			}else{
				//finish
			}
		};
		VMS_timer.delay=5;		
		setTimeout('VMS_timer.start()',VMS_timer.delay);
	
	}
 }
 function doCommandDistrict(id,t){
	if(t==1){
		//if(VMS_map.pointAdd) alert("VMS_map.pointAdd");
		//if(VMS_map.pointEditDetail) alert("VMS_map.pointEditDetail");
		doAjaxPopupForm("jQpopupN","view-container-jQ-n","kpp_shop_google_map_shop_detail_dialog.jsp?"+pub_scrypted+"&district="+id,"Thêm Mới điểm giao dịch",450,650);
						//div_id, div_class, url, title, h, w, modal, resizable
	}else if(t==2){
		doAjaxPopupForm("jQpopupL","view-container-jQ-l","google_map_shop_detail_district_list_v3.jsp?district="+id,"Danh sách điểm giao dịch: "+id,700,900);
	}else if(t==3){
		 window.location = "google_map_shop_detail_district_excel.jsp?province_district="+id;
	}else if(t==4){
		if (VMS_map.doOptionDetail) VMS_map.doOptionDetail(1,id);
	}else if(t==5){
		 window.location = "google_map_shop_detail_district_excel.jsp?province="+id;
	}else if(t==6){
		if (VMS_map.pointSearch) VMS_map.pointSearch(id,6);
	}else if(t==7){
		if (VMS_map.doOptionDetail) VMS_map.doOptionDetail(2,id);
	}else if(t==8){
		if (VMS_map.doOptionDetail) VMS_map.doOptionDetail(3,id);
	}else if(t==9){
		doAjaxPopupForm("jQpopupPL","view-container-jQ-pl","google_map_shop_detail_precinct_list.jsp?precinct="+id,"Danh sách điểm giao dịch: "+id,700,900);
	}else if(t==10){
		if (VMS_map.doOptionDetail) VMS_map.doOptionDetail(4,id);
	}else if(t==11){
		doAjaxPopupForm("jQpopupPN","view-container-jQ-pn","kpp_shop_google_map_shop_detail_dialog.jsp?"+pub_scrypted+"&district="+id.substring(0,7)+"&precinct=123456789","Thêm Mới điểm giao dịch",450,650);
	}
}
VMS_map.doOptionDetail=function(id,key){
	if (id==1){
		if (VMS_map.isBusy){
			alert("Đang đợi phiên làm việc khác thực hiện");
		}else{
			VMS_map.isBusy=true;
			ajaxURLCallback("google_map_shop_detail_get_shop_by_district_key.jsp?key="+key,showShopbyDistrictOnMap,false,key);
		}
	}else if (id==2){
		if (VMS_map.isBusy){
			alert("Đang đợi phiên làm việc khác thực hiện");
		}else{
			VMS_map.isBusy=true;
			ajaxURLCallback("google_map_shop_detail_view_district.jsp?key="+key,doViewDistrict,false,key);
		}
	}else if (id==3){
		if (VMS_map.isBusy){
			alert("Đang đợi phiên làm việc khác thực hiện");
		}else{
			VMS_map.isBusy=true;
			ajaxURLCallback("google_map_shop_detail_view_precinct.jsp?key="+key,doViewPrecinct,false,key);
		}
	}else if (id==4){
		if (VMS_map.isBusy){
			alert("Đang đợi phiên làm việc khác thực hiện");
		}else{
			VMS_map.isBusy=true;
			ajaxURLCallback("google_map_shop_detail_get_shop_by_precinct_key.jsp?key="+key,showShopbyPrecinctOnMap,false,key);
		}
	}
}
function doViewDistrict(data,distid){
		VMS_timer.push(eval(data));
		VMS_timer.fcall=function(obj){
			if (obj){
				VMS_map.mapArea(obj[2],obj[0],obj[1],map_default.r+0.01/*+0.025*/,60,1,3,obj[3]); //ID,lat,lon,rộng của vùng,độ mịn, độ lớn của đường, số thứ tự màu
				VMS_map.mapLatLng(obj[2],obj[0],obj[1],map_default.getimg(6),obj[5],obj[3]);
				if (VMS_map.latlngs[distid]){ //.lat(), VMS_map.latlngs[distid].getPosition().lng()
					VMS_map.createLink(obj[2],new google.maps.LatLng(obj[0],obj[1]),VMS_map.latlngs[distid].getPosition(),"#FF0000",1);
				}
			}else{
				//if (eval(data).length>10) 
				alert("Đã vẽ xong "+eval(data).length+" địa danh Quận/Huyện\nTại: "+distid);
			}
			//kiem tra xong timeout?
		};
		VMS_timer.delay=1; //tra ve gia tri ban dau		
		VMS_timer.start();
		VMS_map.isBusy=false;
}
function doViewPrecinct(data,distid){
		VMS_timer.push(eval(data));
		VMS_timer.fcall=function(obj){
			if (obj){
				VMS_map.mapArea(obj[2],obj[0],obj[1],map_default.r+0.005/*+0.01*/,10,1,4,obj[3]); //ID,lat,lon,rộng của vùng,độ mịn, độ lớn của đường, số thứ tự màu, type=tinh,huyen,xa,shop_type
				VMS_map.mapLatLng(obj[2],obj[0],obj[1],map_default.getimg(5),obj[5],obj[3]);//ID,la,lo,img,tooltip,type=tinh,huyen,xa, shop_type
				if (VMS_map.latlngs[distid]) VMS_map.createLink(obj[2],new google.maps.LatLng(obj[0],obj[1]),VMS_map.latlngs[distid].getPosition(),"#00FF00",1);
			}else{
				//if (eval(data).length>10) 
				alert("Đã vẽ xong "+eval(data).length+" địa danh Phường/Xã\nTại: "+distid);
			}
			//kiem tra xong timeout?
		};
		VMS_timer.delay=1; //tra ve gia tri ban dau		
		VMS_timer.start();
		VMS_map.isBusy=false;
}
////////////////////////////////////
// Tim kiem toa do cho cac diem ban chua co toa do
VMS_pmenu.doOption=function(){
	// goi ajax de lay danh sach cac diem ban ma chua co toa do?
	// sanh sach nay duoc tra ve duoi tap bien,
	// goi thu tuc timer truyen tung bien 1 vao
	// goi ajax de thuc thi ham tim kiem theo dia chi tung bang ghi 1,
	// khi co ket qua, goi ajax de luu vao CSDL 
	// chay timer nay cho den khi het so luong bang ghi 
	// ket thuc
	//alert("ban da bam vao nut tim kiem toa do");
	if (confirm("Bạn muốn nhờ google tìm tọa độ theo danh sách địa chỉ chưa có tọa độ phải không?")){
		if (VMS_map.isBusy){
			alert("Đang đợi phiên làm việc khác thực hiện");
		}else{
			VMS_map.isBusy=true;
			ajaxURLCallback("google_map_shop_detail_search_by_address.jsp?d=1&s=all",doSearchShopFromAddess,false,"");
		}
	}
}
function doSearchShopFromAddess(data,address){
	var dd=eval(data);
	icon_count = dd.length; // do dai cua mang doi tuong can tim
	vcount_ok = 0; //so luong tim thay dia chi
	vcount_nok = 0; // so luong khong tim thay dia chi
	vcount_save = 0; // so luong duoc luu vao csdl
	alert("Bắt đầu tìm kiếm tọa độ theo địa chỉ của : " + icon_count + " điểm bán hàng.\n Xin vui lòng đợi cho đến khi chương trình tìm kiếm xong.");
	if (data&&icon_count>0){
	VMS_timer.push(eval(data)); [[],[]]
	VMS_timer.fcall=function(obj){
		if (obj){
			doSearchAddressAAA(obj[0],obj[1],obj[2]); //dist$shop_id,address,type
		}else{
			//finish
			alert("Đã tìm xong: "+icon_count
				  +" điểm trên bản đồ.\n"
				  +"\nThành công = "+vcount_ok
				  +"\nKhông thành công = "+vcount_nok
				  +"\nLưu vào CSDL thành công = "+vcount_save
			);
			VMS_map.isBusy=false;
		}
	};
	VMS_timer.delay=1000; //10 giay cho 1 phien tim kiem
	VMS_timer.start();
	}
	//VMS_map.isBusy=false;
}
function doSearchAddressAAA(id,address,type){
	// kieu V3 thi phai thay doi khac voi V2, xem V3 lam o duoi
	// muc dich ham nay la truyen vao dia chi, va nho google tra lai toa do
	// sau do luu vao csdl
	var geocoder = new google.maps.Geocoder();
  	   geocoder.geocode({'address': address}, 
  						function(results, status) {
    							if (status == google.maps.GeocoderStatus.OK) {
      							   	if(VMS_timer.count==1) map.setCenter(results[0].geometry.location);
						      		//luu vao csdl roi
						      		//results[0].geometry.location // toa do can luu vao csdl
						      		// lay cac ma cua huyen, cua shop de thao tac tren ban do va luu vao du lieu
				      			    var distid=id.substring(0,id.lastIndexOf("$"));
									var shopid=id.substring(id.lastIndexOf("$")+1);
									// thay lai ham moi dinh diem ban hang nay
									//ID,la,lo,img,tooltip,type=-1=dragable
						      		VMS_map.mapLatLng(id,
						      						  results[0].geometry.location.lat(),
						      						  results[0].geometry.location.lng(),
						      						  map_default.getshop(type),
						      						  'Tìm thấy bởi google từ địa chỉ: '+address,
						      						  -1); //cho keo tha
								    if (VMS_map.latlngs[distid]) VMS_map.createLink(id,
								    												results[0].geometry.location,
								    												VMS_map.latlngs[distid].getPosition(),
								    												"#00FFFF",
								    												1);
				          			vcount_ok = vcount_ok + 1;
				          			//var gaddr=""; //dia chi tu google
              						//lay dia chi cua google de luu vao csdl tu toa do duoc tim thay
              						//Tìm địa chỉ theo tọa độ
								   	var geocoder_address = new google.maps.Geocoder();
								   	var g_address ="";
								   	geocoder_address.geocode({'latLng': results[0].geometry.location},
															function(results_a, status){
																	if (status == google.maps.GeocoderStatus.OK){
																		if (results_a[0]){g_address = results_a[0].formatted_address;}
																	}
																	//luu vao csdl
																	VMS_map.pointEdit(id,results[0].geometry.location.lat(),results[0].geometry.location.lng(),g_address,1);
																	// 2 phien lam viec khac nhau nen ket qua co the khong phu hop
																	vcount_save = vcount_save + 1;
						                							}
                											);
    							} else {
    								//luu vao csdl voi trang thai = 0
    								// khong tim thay dia chi
    								VMS_map.pointEdit(id,"","","",0);
    								vcount_save = vcount_save + 1;
    								vcount_nok = vcount_nok + 1;
    								
    							}
  							}
  						);
}
/////////////////////////////////////////////////
//Ham nay su dung de tim kiem dia chi, theo ma,...
VMS_pmenu.doSearch=function(what){
	if (VMS_map.isBusy)alert("Đang đợi phiên làm việc khác thực hiện");
	else{
		VMS_map.isBusy=true;
		if (what) ajaxURLCallback('google_map_shop_detail_search.jsp?d='+map_default.functionType+'&s='+what,doSearchAny,false,what);
		else VMS_map.isBusy=false;
	}
};
//Tim theo Site, Shop, Dia chi, IMEI,LAC-CI
function doSearchAny(data,address){
	if (data&&data.length>5){
	VMS_timer.push(eval(data));
	VMS_timer.fcall=function(obj){
		if (obj){
			var sid = obj[2];
			if(VMS_timer.count==1) map.setCenter(new google.maps.LatLng(obj[0],obj[1]));
			if (sid.indexOf('.')>0){//day la ma shop_id
				VMS_map.mapLatLng("SEARCH-$"+sid,obj[0],obj[1],map_default.getimg(1),sid,obj[3]); //tip la shop_id, con type=shop_type
				//VMS_map.mapSite(sid,obj[0],obj[1],map_default.getimg(4));
			}else{ //day la ma site_id
				VMS_map.mapSite(sid,obj[0],obj[1],map_default.getimg(1));
			}
		}else{
				//finish
		}
	};
	VMS_timer.start();
	}else if (address){
		//tim theo kieu cua google tim theo dia chi
		doSearchbyAddress(address);
	}
	VMS_map.isBusy=false;
}
function doSearchbyAddress(address){
  //co 2 tinh huong xay ra: theo dia chi hay theo toa do???
  var geocoder = new google.maps.Geocoder;
  //2. Tim theo dia chi
   geocoder.geocode({'address': address}, 
	function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				if (results[1]) {
			        alert('Tìm thấy địa chỉ:'+results[1].formatted_address); // dia chi tim duoc day ne
			        
			        var marker1 = new google.maps.Marker({  icon: map_default.getimg(0),
											        draggable:false,  //Không cho phép kéo điểm này
											        position: results[0].geometry.location,
											        map: VMS_map.map,
											        title: 'Tìm thấy bởi google từ địa chỉ: '+results[1].formatted_address
	      										});
	      			map.setCenter(results[0].geometry.location);
			        
		        } else if (results[0]) {
		        	alert('Tìm thấy tọa độ:'+results[0].geometry.location); // dia chi tim duoc day ne
		        	
			        var marker1 = new google.maps.Marker({  icon: map_default.getimg(0),
											        draggable:false,  //Không cho phép kéo điểm này
											        position: results[0].geometry.location,
											        map: VMS_map.map,
											        title: 'Tìm thấy bởi google từ địa chỉ: '+address
	      										});
	      			map.setCenter(results[0].geometry.location);
			        
		        }else {
			        alert('Google Không tìm ra địa chỉ do bạn nhập vào: '+address+'\n'
						  +'Vui lòng nhập địa chỉ cụ thể và rõ ràng theo đường phố, thành phố, tỉnh thành, và quốc gia');
			    }
			} else {
					alert('Lỗi của Google Không tìm ra địa chỉ do bạn nhập vào: '+address+'!!!');
					// nhay ve tim theo toa do nhe
					//Latlng2Address(address);
			}
		}
	);
}
//////////////////////////////////////////////////////////
function Latlng2Address(ip) {
  var latlngStr = ip.split(',', 2);
  var latlng = {lat: parseFloat(latlngStr[0]), lng: parseFloat(latlngStr[1])};
  var geocoder = new google.maps.Geocoder;
  geocoder.geocode({'location': latlng}, function(rts, st) {
		    if (st === google.maps.GeocoderStatus.OK) {
		      if (rts[1]) {
		        alert(rts[1].formatted_address); // dia chi tim duoc day ne
		      } else {
		        alert('No results found');
		      }
		    } else {
		      alert('Geocoder failed due to: ' + st);
		    }
		  });
}
function repairShopDetail(sid,sname){
	//if (VMS_map.pointEditDetail) VMS_map.pointEditDetail(sid); 
	doAjaxPopupForm("jQpopupE","view-container-jQ-e","kpp_shop_google_map_shop_detail_dialog_repair.jsp?"+sid,"Sửa điểm giao dịch "+sname,450,650);
}
function viewShopImage(sid,sname){
	//viewPopup("kpp_shop_gmap_ShopImage.jsp?"+sid,"HÌNH ẢNH CỦA ĐIỂM GIAO DỊCH "+sname,450,480);
	doAjaxPopupForm("jQpopupI","view-container-jQ-i","kpp_shop_gmap_ShopImage.jsp?"+sid,"HÌNH ẢNH CỦA ĐIỂM GIAO DỊCH "+sname,450,480);
}
//chinh sua thong tin tin da duoc xac nhan
VMS_map.pointEditDetail=function(id,
						  sprov,
						  sdist,
						  saddr,
						  sname,
						  sisdn,
						  stype,
						  sfunc,
						  sdate,
						  sphone,
						  semail,
						  sboss,
						  sez,
						  svietpay,
						  sstaff,
						  sreg,
						  scheck,
						  sdes,
						  scrypt1,
						  scdate,
					      sbdate
						){
	//goi ajax de luu du lieu
	if(confirm("Bạn muốn sửa điểm:<b>"+sname+"</b> \nTại địa chỉ của bạn:<b>"+saddr+ "</b>\n(Có=OK/Không=cancel)")){
		var shopid=id.substring(id.lastIndexOf("$")+1);
		doSaveShopRepair(shopid,
						sprov,
						sdist,
						saddr,
						sname,
						sisdn,
						stype,
						sfunc,
						sdate,
						sphone,
						semail,
						sboss,
						sez,
						svietpay,
						sstaff,
						sreg,
						scheck,
						sdes,
						scrypt1,
						scdate,
					    sbdate
						);
	}
}
/////////////////////
VMS_map.pointAdd=function(id,
						  lat,
						  lon,
						  sprov,
						  sdist,
						  saddr,
						  sname,
						  sisdn,
						  stype,
						  sfunc,
						  sdate,
						  sphone,
						  semail,
						  sboss,
						  sez,
						  svietpay,
						  sstaff,
						  sreg,
						  scheck,
 						  gaddr,
						  scrypt1){
	//goi ajax de luu du lieu
	if(confirm("Bạn muốn tạo điểm:<b>"+sname+"</b>\n\nTại địa chỉ của bạn:\n<b>"+saddr+ "</b>\n\nMà Google tìm được trên bản đồ tại:\n<b>"+gaddr+"</b>\n\nCó thể lưu và điều chỉnh sau bằng cách sửa lại địa chỉ hoặc kéo điểm này đến vị trí chính xác(Có=OK/Không=cancel)")){
		var distid=id.substring(0,id.lastIndexOf("$"));
		var shopid=id.substring(id.lastIndexOf("$")+1);
		if (VMS_map.latlngs[id]&&VMS_map.latlngs[distid]) VMS_map.createLink(id,VMS_map.latlngs[id].getPosition(),VMS_map.latlngs[distid].getPosition(),"#FF0000",1);
		doSaveShopNew(shopid,
						lat,
						lon,
						sprov,
						sdist,
						saddr,
						sname,
						sisdn,
						stype,
						sfunc,
						sdate,
						sphone,
						semail,
						sboss,
						sez,
						svietpay,
						sstaff,
						sreg,
						scheck,
						gaddr,
						scrypt1);
	}
}
//luu tru thong tin diem moi tao 
function doSaveShopNew(id,
						lat,
						lon,
						sprov,
						sdist,
						saddr,
						sname,
						sisdn,
						stype,
						sfunc,
						sdate,
						sphone,
						semail,
						sboss,
						sez,
						svietpay,
						sstaff,
						sreg,
						scheck,
						gaddr,
						scrypt1) {
	$.ajax({
            url: "kpp_shop_google_map_shop_detail_shop_add_save.jsp?"+scrypt1,
            type: "POST",
            cache: false,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded;charset=utf-8",
            data: {id:id,latlngstatus:1,
            		lat:lat,
            		lon:lon,
            		sprov:sprov,
            		sdist:sdist,
            		sname:sname,
            		saddr:saddr,
            		sisdn:sisdn,
            		stype:stype,
            		sfunc:sfunc,
            		sphone:sphone,
            		semail:semail,
            		sdate:sdate,
            		sboss:sboss,
            		sez:sez,
            		svietpay:svietpay,
            		sstaff:sstaff,
            		sreg:sreg,
            		scheck:scheck[0]+","+scheck[1]+","+scheck[2]+","+scheck[3],
            		gaddr:gaddr},
            success: function(json){
				var sid_old = sprov+"-"+sdist+"$"+id;
				//alert(json);
				if (json.shop==null) {
					alert("Điểm vừa tạo không được lưu vào CSDL!. Xin vui lòng liên hệ phòng CNTT để được trợ giúp.");
			    }else{
			    	alert("Đã Lưu Thành Công!\n\nBạn có thể di chuyển điểm mới này đến vị trí chính xác trên bản đồ\nbằng cách kích vào điểm mới tạo giữ chuột phải và kéo rê đi đến vị trí mong muốn.");
					var distid=sprov+"-"+sdist;
					var shopid = json.shop; // ma json tra ve la shop_id moi trong csdl
					if(VMS_map.latlngs[sid_old]){ 
						var newid = distid+"$"+shopid;
						//tao diem moi
						VMS_map.mapLatLng(newid,VMS_map.latlngs[sid_old].getPosition().lat(),VMS_map.latlngs[sid_old].getPosition().lng(),map_default.getimg(1),VMS_map.latlngs[sid_old].latlngAddress,VMS_map.latlngs[sid_old].latlngtype);
						//xoa diem cu
						//map.removeOverlay(VMS_map.latlngs[sid_old]);
						VMS_map.latlngs[sid_old].setMap(null);
						//xoa link cu
						if (VMS_map.links[sid_old]) //map.removeOverlay(VMS_map.links[sid_old]);
						VMS_map.links[sid_old].setMap(null);
						//tao link moi
						if (VMS_map.latlngs[distid])VMS_map.createLink(newid,VMS_map.latlngs[newid].getPosition(),VMS_map.latlngs[distid].getPosition(),"#FF0000",1);
						//ajaxURLCallback("kpp_shop_google_map_shop_detail_get_shop_infor.jsp?shop_id="+shopid,viewShopDetailInfo,false,newid);
						$.ajax({url: "gmap_sql/gmap_v3_shop_click.jsp?sid="+shopid,
						        type: 'POST',
						        cache: false,
						        success: function(o){
						        	showSiteInfo(newid,o,'');
						        },
						        error: function (){
						            alert('Có lỗi xảy ra khi gọi pointClick!');
						        }
						    });
					}
				}
            },
            error: function (data, status, e){
                alert("Có lỗi xảy ra!... "+e);
            },
        	complete:function(data,result)
			{	//Chi thuc hien cac thao tac unbusy thoi
				//alert("Hoàn thành: \n"+json);
			}
        });
}
function doSaveShopRepair(id,
						sprov,
						sdist,
						saddr,
						sname,
						sisdn,
						stype,
						sfunc,
						sdate,
						sphone,
						semail,
						sboss,
						sez,
						svietpay,
						sstaff,
						sreg,
						scheck,
						sdes,
						scrypt1,
						scdate,
					    sbdate
						) {
	$.ajax({
            url: "kpp_shop_google_map_shop_detail_shop_repair_save.jsp?"+scrypt1,
            type: "POST",
            cache: false,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded;charset=utf-8",
            data: "id="+id
            		+"&sprov="+sprov
            		+"&sdist="+sdist
            		+"&sname="+sname
            		+"&saddr="+saddr
            		+"&sisdn="+sisdn
            		+"&stype="+stype
            		+"&sfunc="+sfunc
            		+"&sphone="+sphone
            		+"&semail="+semail
            		+"&sdate="+sdate
            		+"&sboss="+sboss
            		+"&sez="+sez
            		+"&svietpay="+svietpay
            		+"&sstaff="+sstaff
            		+"&sreg="+sreg
            		+"&scheck="+scheck[0]
            		+"&scheck="+scheck[1]
            		+"&scheck="+scheck[2]
            		+"&scheck="+scheck[3]
            		+"&sdes="+sdes
            		+"&scdate="+scdate
            		+"&sbdate="+sbdate,
            success: function(json){
				var sid_old = sprov+"-"+sdist+"$"+id;
				if (json.shop==null) {
					//Điểm này đã bị hủy xóa bỏ rồi nên thực hiện lệnh xóa trên bản đồ
					alert("Điểm này ĐÃ BỊ XÓA BỎ khỏi dữ liệu lưu trữ!");
					//xoa diem cu
					if(VMS_map.latlngs[sid_old]) map.removeOverlay(VMS_map.latlngs[sid_old]);
					//xoa link cu
					if (VMS_map.links[sid_old]) map.removeOverlay(VMS_map.links[sid_old]);
				}else if(VMS_map.latlngs[sid_old]){
					var distid=sid_old.substring(0,sid_old.lastIndexOf("$"));
					var shopid = json.shop;
						$.ajax({url: "gmap_sql/gmap_v3_shop_click.jsp?sid="+shopid,
						        type: 'POST',
						        cache: false,
						        success: function(o){
						        	showSiteInfo(sid_old,o,'');
						        },
						        error: function (){
						            alert('Có lỗi xảy ra khi gọi pointClick!');
						        }
						    });
					}
            },
            error: function (data, status, e){
                alert("Có lỗi xảy ra!... "+e);
            },
        	complete:function(data,result)
			{	//Chi thuc hien cac thao tac unbusy thoi
				//alert("Hoàn thành: \n"+json);
			}
        });
}

</script>